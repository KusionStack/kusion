---
title: "Kusion 核心概念"
linkTitle: "核心概念"
date: 2019-01-20
description: >
  Kusion 的核心概念解析。
weight: 1
---

Kusion 基本架构图如下。

![Kusion 模块大图](arch.png)

## kusion 整体设计原理
Kusion 项目主要由 KCL 语言、K8S 资源模型 SDK、资源状态白盒化框架等 3 大模块构成。
KCL 语言作为面向用户的编程界面，对用户输入的代码进行语义上的解析和执行。但一般来说，用户不会从零开始编写 KCL 语言代码，而是利用封装好的 K8S 资源模型 SDK 来实现对资源的快速部署。为了让资源部署这一原本不透明的状态过程变得可视化，Kusion 项目又引入了资源状态白盒化框架。

### KCL 语言
KCL 是一种通用的动态配置语言，服务 configuration programing 及 problem solving 场景，KCL 为云原生配置系统而设计，但作为一种通用的配置语言不仅限于云原生领域。KCL 吸收了声明式、OOP 编程范式的设计理念，基于此支持对大量不同问题领域配置的开放化建模描述和管理。KCL 希望使用者通过编程方式编写配置，从而更关注人的可读写性。KCL 受动态 PGL Python3 启发，可以视为 Python 的一种方言，所以 K 语言与 Python3 有很多相似之处。

技术的能力边界往往决定了技术系统落地后的复杂性，可维护性，稳定性，安全性等重要因素，在满足了功能性要求后在更长期的未来最终决定系统的生命周期。在设计 KCL 语言时，我们充分考虑了编程范式、功能特性、安全性等方面。总体上 KCL 希望满足如下目标：

* **声明式** ：一个需求只提供一种声明式写法，避免命令式拼装、计算，保持配置代码清晰可读，避免复杂性、副作用
* **场景化** ：不提供与核心目的无关的 built-in 函数与 SDK 支持，尽量降低用户的识别使用心智，做到拿来即用
* **简单小巧** ：可以独立运行，也可以嵌入到服务、operator 中
* **最小集编程能力** ：KCL 定位满足配置语言的基本要素，仅提供最小集可编程能力，不以支持完备图灵计算、全功能语言为目标，以安全、易于审计、面向终态、无二义性为目标
* **语义模型为中心** ：针对配置编写的核心定义，以语义模型为中心，避免语言能力过强造成的噪音干扰及安全性隐患
* **校验能力** ：支持配置编写必须的原生的校验能力
* **IaC、IaD 双向转换** ：通过对兼容 YAML Spec 要素，用户侧编写的配置、测试代码可可以转化为 Infra 侧可接受的配置清单，以遵守 Kubernetes 的设计理念，复用 Kubernetes API 能力；同时针对已有的 IaD 配置，在提供必要 schema 信息的前提下支持转化为 IaC 代码描述。

在我们的实践验证中，通过编程方式声明可以使得终端用户需要编写的代码量大幅减少，这意味着用户需要感知的熵变少，犯错的几率更低。

#### 编程范式
现代高级语言在发展过程中存在互相参考、逐步趋同的情况，这使得现代编程语言在多年发展以后变得非常复杂，为了尽可能满足更多受众的需求，几乎每种主流编程语言都覆盖了指令式、声明式、OOP、函数式成为混合模式语言。作为配置及建模语言，KCL 基于有选择的 OOP、声明式的部分子范式来达到 声明式 编程的效果，提供声明式的外置 `Type & Schema `、 `数据定义` 、 `扩展机制 `。 KCL 语言以表达式 `expression` 为主，仅提供少量必须的语句 `statement` ，如 import 语句。确定编程范式为配置语言的选型定义提供了顶层指导，同时 KCL 将采用描述一种需求只推荐一种写法的思路，例如当命令式语句(如 for)、声明式函数(如 map)、声明式表达式(如  comprehension)都可以满足对指定序列的映射需求时，KCL 语言将提供声明式表达式的方式满足需求。

#### 语言特性
区别于通用编程语言，配置语言的功能目标不包括编写桌面应用、编写 web server，编写移动 app 等应用开发场景，主要聚焦在合理高效的描述资源定义、描述策略表达、描述分布式系统/过程等场景，通过有选择的部分编程特性提升对数据描述的效率，补充静态数据描述能力的不足。

针对云原生配置、策略编写的特点及企业级分布式配置编写的需求，KCL：

• 通过 `module` 机制解决代码单元复用的问题
• 通过 `YAML spec` 兼容 的数据类型定义保证安全的配置编写
• 通过 `immutable` 的数据定义避免命令式编程的噪音及副作用
• 通过简单的外置 `type` + `data` 有机结合满足模型定义、抽象、继承、模板化的需求
• 通过声明式 `logic rule` 支持 problem solving system 的逻辑推导编写，服务如 ABAC 场景
• 通过 `comprehension` 满足结构对象声明式构造的需求，通过 if 满足条件判断的需求
• 通过 `error propagation`  机制支持强异常检测
• 通过丰富的 `built-in`   函数提供配置编写的必须能力
• 通过基于 `python GPL`  的简化方言语法保证语言特性的通用性和群众基础

KCL 旨在通过简单、高效、安全的方式编写云原生配置及测试研发，可以说是针对云原生配置场景的一个安全抽象和简单表达的载体，目前正基于`最小收口原则`逐步确定语言规范，目前 KCL 语言规范正在制定中，后续会推出相关的 Spec 及 KEP 标准。

#### 安全性

KCL 语言通过如下措施保证安全性：
* 不提供有安全隐患的执行函数
* 不提供直接系统调用
* 不提供直接 xml, yaml 加载、解析函数，避免相关的安全漏洞
* 严格的 import 机制避免感染site-packages 或导入路径

#### 语言规范

为了使 KCL语言的的功能特性、信息、计划可见、可协作、可追踪，在研发阶段将通过 proposal 及specification 的形式确定语言规范细节。在语言规范确定后将通过 K Enhancement Proposals （KEP）的形式组织。参考成熟的 EP，KEP 将根据阶段分为 Draft, Accepted, Final, Provisional, Deferred, Rejected, Withdrawn。通过 KEP 机制，语言的相关参与方共同为语言的发展建言献策。

--------------------------------------------------------------------------------

### K8S 资源模型 SDK
为了避免用户从零开发 KCL 语言代码，Kusion 提供了与 OpenAPI Spec 表达含义完全一致的资源模型，并在这些模型的基础之上进行了再一次的封装，使其更接近用户的直观感受。
Kusion 不仅参考 OAM 对 SDK 进行了扩展以方便用户编写代码，还额外提供了 builder、mixin 等多种编程模式，优化执行机制的体验，方便用户以任意的方式对资源进行组装。

#### 资源模型完备
Kusion 支持复用 Kubernetes、Istio 等三百多个经过良好设计的核心模型，对于绝大部分需求可以通过扩展已有模型的方式实现，简单灵活，也避免了翻译类 operator 的存在。对于已有模型无法支持的情况， Kusion 也支持通过自定义模型，即对应于 Kubernetes 中的 CRD 概念。

#### OCMP 实践模型
Kusion 参考开源模型规范 OAM（Open Application Model）中的 component 及 trait 概念进行了扩展，将语言及工具的玩法总结为一套实践模型 Open Cloud-Native Management Practice，旨在帮助用户通过一套简单的编程模型满足其业务需求。参考 OAM 定义，OCMP 定义了面向业务的 component 模型 server、 job、daemon 供用户使用或扩展，并提供了插件化的附件 blocks 定义，同时支持用户自定义 block。目前 Kusion 提供了 server 模型满足试点需求，后续将提供更多模型。

#### 编写资源声明
kusion 面向不同需求的用户提供了三种声明编写方式：适合日常运维使用的 model 模式、适合有较强自定义需求的 builder 模式 和 mixin 模式。

--------------------------------------------------------------------------------
#### 资源状态白盒化框架
k8s 使用者在提交变更后往往需要了解模型的调和步骤，逐步模型观察状态。为了使得用户更易于理解、上手，Kusion 提供对用户变更的模型及其关联模型的变更追踪、链路可视化、live 对比、关键资源可视化、异常定位等功能，帮助用户低成本玩转云原生实践。

#### 过程化
面向终态是云原生系统重要的设计理念，面向终态的调和机制支撑了离散模型的声明式控制，但单纯的面向终态在实践中会造成过程不可控等问题，无法满足企业落地需求。Kusion 通过子集选择将待操作资源分批，通过工作流将分批后的资源操作分段，并支持并行、串行、暂停、恢复、取消等控制操作，从而通过外带的控制能力结合无限循环的调和支持过程化的面向终态。

#### 状态可视化
##### 模型变更的 live diff
Kusion 支持实时地显示模型状态变化之间的差异，这种差异可以以 Json 或是 Yaml 的差异对比（diff）的方式展现出来。其背后的逻辑等同于 kubectl 的 diff 子命令。
##### 关键资源状态可视化
Kusion 支持实时地显示模型当前状态，这些状态信息通过 kusion 内部 monitor 不断监控 k8s runtime 获取。

#### 自动化
Kusion支持根据模型的不同状态自动 异常定位。

对于正常情况，需要了解对链路中模型的状态判断方式，并了解合理的状态判断条件。

以 deployment 为例，如果以社区方式判断则判断 status 中 available 为 true，但如果以较严格的条件判断需要三个 replica 严格相等，加上各个模型存在差异，这使得使用学习路径陡峭提升。

对于异常情况存在类似的情况，往往需要对模型较为了解，并通过多个关联模型关键状态的判断来对判断异常原因。同时对于已提交的资源，Kusion 将提供资源状态白屏展示，降低用户识别成本。

